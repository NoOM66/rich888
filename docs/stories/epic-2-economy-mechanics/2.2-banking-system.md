# Story 2.2: Implement Banking System

**Epic:** Inflation & Economy Mechanics

## 1. Story
ในฐานะผู้เล่น (As a player), ฉันต้องการระบบธนาคารที่ฉันสามารถฝากเงินเพื่อรับดอกเบี้ยและกู้ยืมเงินได้ (I want a banking system where I can deposit money to earn interest and take out loans) เพื่อให้ฉันมีเครื่องมือในการจัดการการเงินและรับมือกับภาวะเงินเฟ้อได้มากขึ้น (so I have more tools to manage my finances and deal with inflation).

## 2. Acceptance Criteria (เกณฑ์การยอมรับ)
- [ ] มี `BankingManager.cs` Script ในโปรเจกต์
- [ ] ผู้เล่นสามารถ "ฝากเงิน" (Deposit) จากเงินสด (Cash) เข้าบัญชีธนาคาร (Bank Balance) ได้
- [ ] เงินในบัญชีธนาคารจะได้รับดอกเบี้ยทุกๆ 4 สัปดาห์ โดยอัตราดอกเบี้ยจะต่ำกว่าอัตราเงินเฟ้อ
- [ ] ผู้เล่นสามารถ "ถอนเงิน" (Withdraw) จากบัญชีธนาคารกลับมาเป็นเงินสดได้
- [ ] ผู้เล่นสามารถ "กู้เงิน" (Take a Loan) ได้ตามวงเงินที่กำหนด (อาจจะคำนวณจากรายได้)
- [ ] เงินกู้มี "อัตราดอกเบี้ย" ที่ผันผวนตาม `CurrentInflationRate`
- [ ] ผู้เล่นต้อง "ผ่อนชำระ" เงินกู้เป็นงวดๆ (เช่น ทุก 4 สัปดาห์)
- [ ] หากไม่ชำระหนี้ตามกำหนด จะถูกคิดดอกเบี้ยเพิ่มและหักจากเงินสดที่มีอยู่

## 3. Tasks / Subtasks (งานย่อย)
- [ ] **1. สร้าง BankingManager Script:**
  - [ ] 1.1. สร้าง C# Script ใหม่ชื่อ `BankingManager.cs` และทำให้เป็น Singleton

- [ ] **2. ขยาย PlayerData สำหรับข้อมูลธนาคารและเงินกู้:**
  - [ ] 2.1. ใน `PlayerData.cs` (จาก Story 1.3), เพิ่ม `public float BankBalance;`
  - [ ] 2.2. สร้างคลาส `Loan.cs` (Serializable) สำหรับเก็บข้อมูลเงินกู้ (เช่น `amount`, `interestRate`, `remainingPayments`, `nextPaymentDueDate`)
  - [ ] 2.3. ใน `PlayerData.cs`, เพิ่ม `public List<Loan> activeLoans;`

- [ ] **3. พัฒนากลไกฝาก/ถอนเงิน:**
  - [ ] 3.1. สร้างฟังก์ชัน `public void Deposit(float amount)` และ `public void Withdraw(float amount)` ใน `BankingManager`
  - [ ] 3.2. ฟังก์ชันเหล่านี้ต้องเรียกใช้ `PlayerStatsController` เพื่อจัดการเงินสดและยอดเงินในธนาคาร

- [ ] **4. พัฒนากลไกดอกเบี้ยเงินฝาก:**
  - [ ] 4.1. ให้ `BankingManager` ดักฟัง Event `OnWeekStart` (หรือ `OnMonthStart` ถ้าดอกเบี้ยคิดเป็นรายเดือน)
  - [ ] 4.2. คำนวณดอกเบี้ยจาก `BankBalance` และเพิ่มเข้าไปในยอดเงินฝาก โดยอัตราดอกเบี้ยต้องต่ำกว่าอัตราเงินเฟ้อ

- [ ] **5. พัฒนากลไกเงินกู้:**
  - [ ] 5.1. สร้างฟังก์ชัน `public Loan TakeLoan(float amount)`
  - [ ] 5.2. คำนวณอัตราดอกเบี้ยเงินกู้โดยอ้างอิงจาก `InflationManager.CurrentInflationRate`
  - [ ] 5.3. เพิ่มเงินกู้เข้าใน `activeLoans` ของ `PlayerData`
  - [ ] 5.4. สร้างฟังก์ชัน `public void MakeLoanPayment(Loan loan, float amount)` เพื่อชำระเงินกู้

- [ ] **6. พัฒนากลไกบทลงโทษเมื่อผิดนัดชำระ:**
  - [ ] 6.1. ให้ `BankingManager` ดักฟัง Event `OnWeekStart` (หรือ `OnMonthStart`)
  - [ ] 6.2. ตรวจสอบเงินกู้ที่ถึงกำหนดชำระ
  - [ ] 6.3. หากผิดนัดชำระ, ให้คำนวณดอกเบี้ยเพิ่มและหักจากเงินสดของผู้เล่น
  - [ ] 6.4. หากเงินสดไม่พอ, ให้จัดการสถานะล้มละลาย (เช่น ยิง Event `OnBankruptcy` หรือ `OnPlayerLost`)

- [ ] **7. เชื่อมต่อกับระบบ Event:**
  - [ ] 7.1. ใช้ Global Event System สำหรับ Event ต่างๆ เช่น `OnDeposit`, `OnWithdrawal`, `OnLoanTaken`, `OnLoanPaymentMade`, `OnMissedPayment`, `OnBankruptcy`

- [ ] **8. เขียน Unit Tests:**
  - [ ] 8.1. เทสกลไกฝาก/ถอนเงิน และกรณีขอบเขต (เช่น ถอนเกินยอด)
  - [ ] 8.2. เทสการคำนวณดอกเบี้ยเงินฝาก
  - [ ] 8.3. เทสการสร้างเงินกู้และการชำระเงินกู้
  - [ ] 8.4. เทสการคำนวณบทลงโทษเมื่อผิดนัดชำระ และการจัดการสถานะล้มละลาย

## 4. Dev Notes (บันทึกสำหรับนักพัฒนา)
- การจัดการดอกเบี้ยเงินฝากและเงินกู้ที่ผันผวนตามเงินเฟ้อเป็นจุดสำคัญที่ต้องคำนวณให้ถูกต้องและสมจริง
- ควรมี UI ชั่วคราวสำหรับแสดงยอดเงินในธนาคาร, รายการเงินกู้, และปุ่มฝาก/ถอน/กู้ เพื่อใช้ในการดีบัก

## 5. QA / Testing Notes (บันทึกสำหรับ QA และการทดสอบ)
- ทดสอบการฝาก/ถอนเงินในทุกกรณี รวมถึงกรณีที่เงินสดไม่พอถอน
- ทดสอบการกู้เงินและการผ่อนชำระในสถานการณ์ต่างๆ
- ทดสอบกรณีผิดนัดชำระหนี้ ว่าบทลงโทษทำงานถูกต้องและจัดการสถานะล้มละลายได้
- ตรวจสอบว่าดอกเบี้ยเงินฝากถูกคำนวณและเพิ่มเข้าบัญชีตามรอบเวลาที่กำหนด

## 6. Dependencies (สตอรี่ที่เกี่ยวข้อง)
- **Story 1.2: Implement Turn & Time Management System:** `BankingManager` ต้องใช้ Event `OnWeekStart` เพื่อคำนวณดอกเบี้ยและตรวจสอบการชำระหนี้
- **Story 1.3: Implement Player Stats System:** `BankingManager` ต้องเรียกใช้ฟังก์ชันใน `PlayerStatsController` เพื่อจัดการเงินสดและค่าสถานะอื่นๆ
- **Story 1.5: Implement Global Event System:** ต้องใช้ระบบ Event กลางในการส่ง Event ต่างๆ
- **Story 2.1: Implement the core Inflation System:** `BankingManager` ต้องดึง `CurrentInflationRate` มาใช้ในการคำนวณดอกเบี้ยเงินฝากและเงินกู้

---
## Dev Agent Record
- **Agent Model Used:**
- **Debug Log References:**
- **Completion Notes:**
- **File List:**
- **Change Log:**
