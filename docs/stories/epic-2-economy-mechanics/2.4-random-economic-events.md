# Story 2.4: Implement Random Economic Events

**Epic:** Inflation & Economy Mechanics
**Status:** Ready for Review

## 1. Story
ในฐานะผู้เล่น (As a player), ฉันต้องการให้เกมมีเหตุการณ์ทางเศรษฐกิจแบบสุ่มที่สามารถส่งผลกระทบเชิงบวกหรือลบต่อการเงินและค่าสถานะของฉันได้ (I want the game to introduce random economic events that can positively or negatively impact my finances and stats) เพื่อให้เกมรู้สึกมีชีวิตชีวาและคาดเดาไม่ได้ สะท้อนความผันผวนทางเศรษฐกิจในโลกจริง (so that the game feels dynamic and unpredictable, reflecting real-world economic volatility).

## 2. Acceptance Criteria (เกณฑ์การยอมรับ)
- [x] มี `EconomicEventManager.cs` Script ในโปรเจกต์
- [x] ระบบมีชุดของเหตุการณ์ทางเศรษฐกิจที่กำหนดไว้ล่วงหน้า (เช่น ใช้ ScriptableObject สำหรับแต่ละ Event)
- [x] แต่ละ Event มีคุณสมบัติเช่น `name`, `description`, `type` (บวก/ลบ), `triggerCondition` (เช่น โอกาสต่อสัปดาห์, ช่วงสัปดาห์ที่กำหนด), และ `effects` (เช่น เปลี่ยนแปลงเงิน, ค่าสถานะ, อัตราเงินเฟ้อ)
- [x] ระบบจะตรวจสอบและเรียกใช้ Event สุ่มเป็นระยะ (เช่น ทุกสัปดาห์มีโอกาสเกิด Event)
- [x] เมื่อ Event ถูกเรียกใช้, ผลกระทบของ Event จะถูกนำไปใช้กับค่าสถานะของผู้เล่นและ/หรือเศรษฐกิจในเกม
- [x] มีการแจ้งเตือนที่ชัดเจน (เช่น UI pop-up) แสดงให้ผู้เล่นทราบเมื่อมี Event เกิดขึ้น
- [x] ตัวอย่าง Event: "ราคาน้ำมันพุ่งสูงขึ้น" (ลบ, กระทบเงิน/ค่าครองชีพ), "รัฐบาลแจกเงินกระตุ้นเศรษฐกิจ" (บวก, เพิ่มเงิน), "ตลาดหุ้นล่ม" (ลบ, กระทบการลงทุน)

## 3. Tasks / Subtasks (งานย่อย)
- [x] **1. สร้าง ScriptableObject สำหรับ Economic Event:**
  - [x] 1.1. สร้าง C# Script ใหม่ชื่อ `EconomicEventSO.cs` ที่สืบทอดจาก `ScriptableObject`
  - [x] 1.2. กำหนด Fields สำหรับ `eventName`, `description`, `eventType` (enum: Positive, Negative, Neutral), `triggerChancePerWeek`, `moneyChange`, `healthChange`, `happinessChange`, `educationChange`, `stressChange`, `inflationRateChange`
  - [x] 1.3. สร้าง Asset สำหรับ Event ตัวอย่าง 2-3 ตัว (เช่น "ราคาน้ำมันพุ่งสูงขึ้น", "รัฐบาลแจกเงิน", "ตลาดหุ้นล่ม")

- [x] **2. สร้าง EconomicEventManager Script:**
  - [x] 2.1. สร้าง C# Script ใหม่ชื่อ `EconomicEventManager.cs` และทำให้เป็น Singleton
  - [x] 2.2. เพิ่ม List ของ `EconomicEventSO` Assets ที่จะถูกจัดการ

- [x] **3. พัฒนากลไกการเรียกใช้ Event สุ่ม:**
  - [x] 3.1. ให้ `EconomicEventManager` ดักฟัง Event `OnWeekStart` จาก `TurnManager`
  - [x] 3.2. ใน `OnWeekStart` handler, วนลูปตรวจสอบ Event แต่ละตัวตาม `triggerChancePerWeek`
  - [x] 3.3. หาก Event ถูกเรียกใช้, ให้เรียกฟังก์ชัน `private void ApplyEventEffects(EconomicEventSO eventData)`

- [x] **4. พัฒนากลไกการประยุกต์ใช้ผลกระทบของ Event:**
  - [x] 4.1. ใน `ApplyEventEffects` ให้เรียกใช้ `PlayerStatsController` เพื่อปรับค่าสถานะผู้เล่น
  - [x] 4.2. เรียกใช้ `InflationManager` เพื่อปรับ `inflationRateChange`
  - [x] 4.3. ยิง Event ผ่าน Global Event System เพื่อแสดง UI Notification (เช่น `OnShowNotification` พร้อมส่ง `eventName` และ `description`)

- [x] **5. เชื่อมต่อกับระบบ Event:**
  - [x] 5.1. ใช้ Global Event System สำหรับ Event `OnEconomicEventTriggered` (ส่ง `EconomicEventSO` data ไปด้วย)

- [x] **6. เขียน Unit Tests:**
  - [x] 6.1. เทสว่า Event ถูกเรียกใช้ตามโอกาสที่กำหนด (อาจต้องรันหลายครั้งหรือใช้ Mock Random)
  - [x] 6.2. เทสว่า `ApplyEventEffects` ปรับค่าสถานะผู้เล่นและอัตราเงินเฟ้อได้ถูกต้อง
  - [x] 6.3. เทสว่ามีการยิง Event สำหรับ UI Notification เมื่อ Event เกิดขึ้น

## 4. Dev Notes (บันทึกสำหรับนักพัฒนา)
- การออกแบบ `EconomicEventSO` ให้ยืดหยุ่นจะช่วยให้เพิ่ม Event ใหม่ๆ ได้ง่ายในอนาคตโดยไม่ต้องแก้ไขโค้ด
- ควรมี UI ชั่วคราวสำหรับแสดง Event ที่เกิดขึ้น เพื่อใช้ในการดีบักและทดสอบ

## 5. QA / Testing Notes (บันทึกสำหรับ QA และการทดสอบ)
- ทดสอบ Event แต่ละประเภทว่ามีผลกระทบต่อค่าสถานะและเศรษฐกิจตามที่กำหนด
- ทดสอบว่า Event ถูกเรียกใช้ตามโอกาสที่กำหนด (อาจต้องรันเกมหลายๆ รอบ)
- ตรวจสอบว่า UI Notification แสดงผลถูกต้องเมื่อ Event เกิดขึ้น

## 6. Dependencies (สตอรี่ที่เกี่ยวข้อง)
- **Story 1.2: Implement Turn & Time Management System:** `EconomicEventManager` ต้องใช้ Event `OnWeekStart` เพื่อตรวจสอบการเรียกใช้ Event
- **Story 1.3: Implement Player Stats System:** `EconomicEventManager` ต้องเรียกใช้ฟังก์ชันใน `PlayerStatsController` เพื่อปรับค่าสถานะ
- **Story 1.5: Implement Global Event System:** ต้องใช้ระบบ Event กลางในการส่ง Event ต่างๆ
- **Story 2.1: Implement the core Inflation System:** `EconomicEventManager` อาจจะปรับค่า `CurrentInflationRate` ได้โดยตรง

---
## Dev Agent Record
- **Agent Model Used:** Gemini
- **Debug Log References:**
  - Created EconomicEvent.ts interface and EconomicEventsData.ts.
  - Created EconomicEventManager.ts as a TypeScript Singleton.
  - Implemented event listening and random event triggering logic in EconomicEventManager.ts.
  - Implemented applyEventEffects method in EconomicEventManager.ts.
  - Created comprehensive unit tests for EconomicEventManager.ts.
  - Created EconomicEvent.ts interface and EconomicEventsData.ts.
  - Created EconomicEventManager.ts as a TypeScript Singleton.
- **Completion Notes:**
  - Implemented the Random Economic Events system according to the story, adapting C#/.NET concepts to TypeScript/Phaser.
  - The system triggers random events based on defined chances and applies their effects to player stats and inflation.
  - UI notifications are emitted for triggered events.
  - All core functionalities are complete and unit-tested.
- **File List:**
  - GameDev/Rich/src/EconomicEvent.ts
  - GameDev/Rich/src/EconomicEventsData.ts
  - GameDev/Rich/src/EconomicEventManager.ts
  - GameDev/Rich/src/EconomicEventManager.test.ts
  - GameDev/Rich/src/PlayerStatsController.ts (updated)
  - GameDev/Rich/src/InflationManager.ts (updated)
  - GameDev/Rich/src/EconomicEvent.ts
  - GameDev/Rich/src/EconomicEventsData.ts
  - GameDev/Rich/src/EconomicEventManager.ts
- **Change Log:**
  - Initial implementation of Random Economic Events system.
  - Integration with PlayerStatsController, InflationManager, and GlobalEventEmitter.
  - Unit tests for EconomicEventManager.
