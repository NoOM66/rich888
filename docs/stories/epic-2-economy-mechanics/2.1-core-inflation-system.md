# Story 2.1: Implement the core Inflation System

**Epic:** Inflation & Economy Mechanics

## 1. Story
ในฐานะผู้เล่น (As a player), ฉันต้องการให้เกมมีระบบเงินเฟ้อหลักที่ส่งผลกระทบต่อเศรษฐกิจในเกมอย่างสมจริง (I want the game to have a core inflation system that realistically affects the game's economy) เพื่อให้ฉันได้สัมผัสกับความท้าทายจากมูลค่าเงินที่ลดลงและค่าครองชีพที่สูงขึ้น (so that I can feel the challenge of my money losing value and the rising cost of living).

## 2. Acceptance Criteria (เกณฑ์การยอมรับ)
- [x] มี `InflationManager.cs` Script ในโปรเจกต์ และเป็น Singleton
- [x] `InflationManager` มีค่า `public float CurrentInflationRate` (เช่น 0.02 สำหรับ 2%) ที่ระบบอื่นสามารถเข้ามาดูได้
- [x] `InflationManager` มีกลไกในการเปลี่ยนแปลงอัตราเงินเฟ้อเป็นระยะ (เช่น ทุกๆ 4 สัปดาห์)
- [x] เมื่ออัตราเงินเฟ้อเปลี่ยนแปลง, จะต้องมีการยิง Event `OnInflationChanged` (ผ่าน Global Event System) พร้อมส่งค่าอัตราเงินเฟ้อใหม่ไปด้วย
- [x] มีระบบที่ดักฟัง Event `OnInflationChanged` เพื่อลดมูลค่าเงินสดที่ผู้เล่นถืออยู่ (Purchasing Power Reduction)
- [x] ระบบอื่นๆ (เช่น ร้านค้า, ค่าเช่าบ้าน) สามารถเข้าถึง `CurrentInflationRate` เพื่อนำไปปรับราคาสินค้าและบริการของตนเองได้

## 3. Tasks / Subtasks (งานย่อย)
- [x] **1. สร้าง InflationManager Script:**
  - [x] 1.1. สร้าง C# Script ใหม่ชื่อ `InflationManager.cs` และทำให้เป็น Singleton
  - [x] 1.2. สร้าง public property `CurrentInflationRate`

- [x] **2. พัฒนากลไกการเปลี่ยนแปลงเงินเฟ้อ:**
  - [x] 2.1. ให้ `InflationManager` ดักฟัง Event `OnWeekStart`
  - [x] 2.2. สร้างตัวนับสัปดาห์ และเมื่อครบตามที่กำหนด (เช่น ทุก 4 สัปดาห์) ให้ทำการสุ่มค่าเงินเฟ้อใหม่
  - [x] 2.3. การสุ่มค่าให้อยู่ในขอบเขต `minInflationRate` และ `maxInflationRate` ที่กำหนดไว้ใน Inspector ได้

- [x] **3. เชื่อมต่อกับระบบ Event:**
  - [x] 3.1. สร้าง `GameEventChannelSO<float>` Asset ใหม่ชื่อ `OnInflationChangedEvent`
  - [x] 3.2. เมื่อมีการเปลี่ยนแปลงค่าเงินเฟ้อ ให้ `InflationManager` เรียกใช้ `.Raise()` บน Event Channel นี้พร้อมส่งค่าใหม่ไปด้วย

- [x] **4. พัฒนากลไกการลดมูลค่าเงิน:**
  - [x] 4.1. ใน `PlayerStatsController` (หรือคลาสที่จัดการเงินโดยเฉพาะ), ให้สร้างฟังก์ชันที่ดักฟัง `OnInflationChangedEvent`
  - [x] 4.2. เมื่อได้รับ Event, ให้คำนวณและลดมูลค่าของเงินสดที่ผู้เล่นถืออยู่ตามอัตราเงินเฟ้อ (อาจจะลดกำลังซื้อโดยการทำให้ของแพงขึ้นทางอ้อม)

- [x] **5. เขียน Unit Tests:**
  - [x] 5.1. เทสว่าอัตราเงินเฟ้อเปลี่ยนแปลงหลังจากครบจำนวนสัปดาห์ที่กำหนด
  - [x] 5.2. เทสว่าค่าเงินเฟ้อใหม่อยู่ในขอบเขต min/max
  - [x] 5.3. เทสว่า Event `OnInflationChanged` ถูกยิงพร้อมค่าที่ถูกต้อง

## 4. Dev Notes (บันทึกสำหรับนักพัฒนา)
- กลไกการลดมูลค่าเงิน (ข้อ 4.2) เป็นเรื่องที่ต้องออกแบบให้ดี อาจจะไม่ใช่การลดจำนวนเงินโดยตรง แต่อาจจะเป็นการเพิ่มราคาสินค้าในร้านค้าต่างๆ ซึ่งจะถูกพัฒนาในสตอรี่ถัดๆ ไป ในสตอรี่นี้ให้เน้นที่การสร้างระบบ `InflationManager` และการยิง Event ให้ถูกต้องก่อน
- ควรมี UI ชั่วคราวสำหรับแสดง `CurrentInflationRate` เพื่อใช้ในการดีบัก

## 5. QA / Testing Notes (บันทึกสำหรับ QA และการทดสอบ)
- ต้องทดสอบโดยการเร่งเวลาในเกม (ผ่าน Cheat/Debug menu) เพื่อดูว่าอัตราเงินเฟ้อเปลี่ยนแปลงตามรอบเวลาที่กำหนดจริง
- ตรวจสอบว่า Event ถูกส่งออกไปให้ระบบอื่นรับรู้ได้จริง

## 6. Dependencies (สตอรี่ที่เกี่ยวข้อง)
- **Story 1.2: Implement Turn & Time Management System:** `InflationManager` ต้องใช้ Event `OnWeekStart` เพื่อนับรอบเวลา
- **Story 1.5: Implement Global Event System:** ต้องใช้ระบบ Event กลางในการส่ง `OnInflationChangedEvent`

---
## Dev Agent Record
- **Agent Model Used:** Gemini
- **Debug Log References:**
  - Implemented `InflationManager.ts` as a TypeScript Singleton.
  - Integrated `InflationManager` with `GlobalEventEmitter` for event emission and listening to `onWeekStart`.
  - Implemented purchasing power reduction in `PlayerStatsController.ts` by listening to `onInflationChanged`.
  - Added UI elements in `main.ts` to display `CurrentInflationRate`.
  - Wrote comprehensive unit tests for `InflationManager` covering all specified tasks and acceptance criteria.
  - Resolved multiple TypeScript and Jest mocking issues during unit testing of `InflationManager`.
  - All 42 unit tests for all managers passed successfully.
- **Completion Notes:**
  - Implemented the core Inflation System according to the story, adapting C#/.NET concepts to TypeScript/Phaser.
  - The system manages `CurrentInflationRate`, changes it periodically, and emits `onInflationChanged` event.
  - Purchasing power reduction is implemented in `PlayerStatsController` for demonstration.
  - The core functionality is complete and unit-tested.
- **File List:**
  - `GameDev/Rich/src/InflationManager.ts`
  - `GameDev/Rich/src/InflationManager.test.ts`
  - `GameDev/Rich/src/PlayerStatsController.ts` (updated)
  - `GameDev/Rich/src/main.ts` (updated)
- **Change Log:**
  - Initial implementation of Inflation System.
  - Integration with TurnManager and PlayerStatsController.
  - Unit tests for InflationManager.