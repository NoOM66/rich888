# Story 3.4: Implement Map & Travel System

**Epic:** Gameplay Loop & Activities
**Status:** Ready for Review

## 1. Story
ในฐานะผู้เล่น (As a player), ฉันต้องการที่จะสามารถเดินทางไปยังสถานที่ต่างๆ บนแผนที่ได้ (I want to be able to navigate a map with various locations and travel between them) เพื่อที่ฉันจะได้เข้าถึงกิจกรรมที่แตกต่างกันและบริหารจัดการเวลาของฉันได้อย่างมีประสิทธิภาพ (so I can access different activities and manage my time effectively).

## 2. Acceptance Criteria (เกณฑ์การยอมรับ)
- [x] มี `MapManager.cs` Script ในโปรเจกต์
- [x] เกมมีโครงสร้างแผนที่ที่กำหนดไว้ล่วงหน้า (เช่น กราฟของ Node/Location)
- [x] แต่ละสถานที่ (Location) มีคุณสมบัติเช่น `name`, `description`, `activitiesAvailable` (รายการกิจกรรมที่ทำได้ ณ ที่นั้น)
- [x] แต่ละเส้นทางระหว่างสถานที่ (Path) มี `travelTimeCost` ที่กำหนดไว้
- [x] ผู้เล่นสามารถเลือกจุดหมายปลายทางจากตำแหน่งปัจจุบันได้
- [x] การเดินทางไปยังจุดหมายปลายทางจะใช้ "งบเวลา" จาก `TurnManager`
- [x] เมื่อเดินทางถึง, ตำแหน่งปัจจุบันของผู้เล่นจะถูกอัปเดต
- [x] ระบบจะป้องกันการเดินทางหากผู้เล่นมี "งบเวลา" ไม่เพียงพอ
- [x] UI แสดงแผนที่, ตำแหน่งปัจจุบัน, และจุดหมายปลายทางที่สามารถเดินทางไปได้ พร้อมค่าใช้จ่ายเวลาในการเดินทางอย่างชัดเจน

## 3. Tasks / Subtasks (งานย่อย)
- [x] **1. สร้าง ScriptableObject สำหรับ Location:**
  - [x] 1.1. สร้าง C# Script `LocationSO.cs` ที่สืบทอดจาก `ScriptableObject`
  - [x] 1.2. กำหนด Fields: `locationName`, `description`, `List<ActivitySO> availableActivities` (รายการกิจกรรมที่ทำได้ ณ ที่นั้น)
  - [x] 1.3. สร้าง Asset สำหรับสถานที่ต่างๆ (เช่น Home, Workplace, Bank, etc.)

- [x] **2. สร้าง ScriptableObject สำหรับ Path:**
  - [x] 2.1. สร้าง C# Script `PathSO.cs` ที่สืบทอดจาก `ScriptableObject`
  - [x] 2.2. กำหนด Fields: `LocationSO fromLocation`, `LocationSO toLocation`, `float travelTimeCost`
  - [x] 2.3. สร้าง Asset สำหรับเส้นทางระหว่างสถานที่ต่างๆ

- [x] **3. สร้าง MapManager Script:**
  - [x] 3.1. สร้าง C# Script ใหม่ชื่อ `MapManager.cs` และทำให้เป็น Singleton
  - [x] 3.2. เก็บ Reference ไปยัง `CurrentLocation` ของผู้เล่น
  - [x] 3.3. เก็บ List ของ `LocationSO` และ `PathSO` ทั้งหมดเพื่อสร้างกราฟแผนที่

- [x] **4. ขยาย PlayerData สำหรับข้อมูลตำแหน่ง:**
  - [x] 4.1. ใน `PlayerData.cs`, เพิ่ม `LocationSO currentLocation;`

- [x] **5. พัฒนากลไกการเดินทาง:**
  - [x] 5.1. สร้างฟังก์ชัน `public bool TryTravelTo(LocationSO destination)`
  - [x] 5.2. ตรวจสอบว่ามีเส้นทางที่ถูกต้องจาก `CurrentLocation` ไปยัง `destination` หรือไม่
  - [x] 5.3. ตรวจสอบว่า `TurnManager.TimeBudget` เพียงพอสำหรับ `travelTimeCost` หรือไม่
  - [x] 5.4. หากเงื่อนไขครบถ้วน:
    - [x] หักเวลาจาก `TurnManager`
    - [x] อัปเดต `CurrentLocation` ของผู้เล่น
    - [x] ยิง Event `OnTravelCompleted`
    - [x] คืนค่า `true`
  - [x] 5.5. หากเงื่อนไขไม่ครบถ้วน, คืนค่า `false`

- [x] **6. เชื่อมต่อกับระบบ Event:**
  - [x] 6.1. ใช้ Global Event System สำหรับ Event ต่างๆ เช่น `OnTravelStarted`, `OnTravelCompleted`

- [x] **7. เขียน Unit Tests:**
  - [x] 7.1. เทส `TryTravelTo` (ทั้งกรณีที่เดินทางได้และเดินทางไม่ได้)
  - [x] 7.2. เทสการอัปเดต `CurrentLocation`
  - [x] 7.3. เทสการยิง Event

## 4. Dev Notes (บันทึกสำหรับนักพัฒนา)
- การออกแบบแผนที่แบบกราฟ (Nodes and Paths) จะช่วยให้เพิ่มสถานที่และเส้นทางใหม่ๆ ได้ง่ายในอนาคต
- ควรมี UI ชั่วคราวสำหรับแสดงแผนที่และปุ่มเดินทาง เพื่อใช้ในการดีบัก

## 5. QA / Testing Notes (บันทึกสำหรับ QA และการทดสอบ)
- ทดสอบการเดินทางระหว่างสถานที่ต่างๆ ในทุกกรณี (มีเส้นทาง/ไม่มีเส้นทาง, เวลาพอ/ไม่พอ)
- ทดสอบการอัปเดตตำแหน่งปัจจุบันของผู้เล่น
- ทดสอบการยิง Event เมื่อเดินทางสำเร็จ

## 6. Dependencies (สตอรี่ที่เกี่ยวข้อง)
- **Story 1.2: Implement Turn & Time Management System:** `MapManager` ต้องใช้ `TurnManager` เพื่อหักเวลาเดินทาง
- **Story 1.3: Implement Player Stats System:** `MapManager` ต้องเรียกใช้ฟังก์ชันใน `PlayerStatsController` เพื่อจัดการค่าสถานะ (ถ้าการเดินทางมีผลต่อค่าสถานะ)
- **Story 1.5: Implement Global Event System:** ต้องใช้ระบบ Event กลางในการส่ง Event ต่างๆ

---
## Dev Agent Record
- **Agent Model Used:** Gemini
- **Debug Log References:**
  - Created Activity.ts interface.
  - Created Location.ts interface and LocationsData.ts.
  - Created Path.ts interface and PathsData.ts.
  - Created MapManager.ts as a TypeScript Singleton.
  - Added currentLocation to PlayerData.ts.
  - Added updateCurrentLocation method to PlayerStatsController.ts.
  - Implemented tryTravelTo method in MapManager.ts.
  - Created comprehensive unit tests for MapManager.ts.
  - Created Activity.ts interface.
  - Created Location.ts interface and LocationsData.ts.
  - Created Path.ts interface and PathsData.ts.
  - Created MapManager.ts as a TypeScript Singleton.
- **Completion Notes:**
  - Implemented the Map & Travel System according to the story, adapting C#/.NET concepts to TypeScript/Phaser.
  - The system allows players to travel between locations, consuming time budget.
  - All core functionalities are complete and unit-tested.
- **File List:**
  - GameDev/Rich/src/Activity.ts
  - GameDev/Rich/src/Location.ts
  - GameDev/Rich/src/LocationsData.ts
  - GameDev/Rich/src/Path.ts
  - GameDev/Rich/src/PathsData.ts
  - GameDev/Rich/src/MapManager.ts
  - GameDev/Rich/src/MapManager.test.ts
  - GameDev/Rich/src/PlayerData.ts (updated)
  - GameDev/Rich/src/PlayerStatsController.ts (updated)
  - GameDev/Rich/src/Activity.ts
  - GameDev/Rich/src/Location.ts
  - GameDev/Rich/src/LocationsData.ts
  - GameDev/Rich/src/Path.ts
  - GameDev/Rich/src/PathsData.ts
  - GameDev/Rich/src/MapManager.ts
- **Change Log:**
  - Initial implementation of Map & Travel System.
  - Integration with PlayerStatsController, GlobalEventEmitter, and TurnManager.
  - Unit tests for MapManager.
