# Story 3.5: Implement Home/Housing System

**Epic:** Gameplay Loop & Activities
**Status:** Ready for Review

## 1. Story
ในฐานะผู้เล่น (As a player), ฉันต้องการที่จะสามารถเลือกที่อยู่อาศัยและจัดการค่าใช้จ่ายในการอยู่อาศัยได้ (I want to be able to choose a home and manage my living expenses) เพื่อที่ฉันจะได้ตัดสินใจเชิงกลยุทธ์เกี่ยวกับสถานการณ์ที่อยู่อาศัยของฉันและสัมผัสถึงผลกระทบของเงินเฟ้อต่อค่าเช่าและค่าสาธารณูปโภค (so I can make strategic decisions about my housing situation and feel the impact of inflation on rent and utilities).

## 2. Acceptance Criteria (เกณฑ์การยอมรับ)
- [x] มี `HousingManager.cs` Script ในโปรเจกต์
- [x] เกมมีชุดของตัวเลือกที่อยู่อาศัยที่กำหนดไว้ล่วงหน้า (เช่น ใช้ ScriptableObject สำหรับบ้านแต่ละประเภท)
- [x] ที่อยู่อาศัยแต่ละประเภทมีคุณสมบัติเช่น `name`, `description`, `baseRent`, `baseUtilitiesCost`, `capacity`, `happinessBonus`
- [x] ผู้เล่นสามารถเลือกที่อยู่อาศัยเริ่มต้นได้
- [x] ค่าเช่าและค่าสาธารณูปโภคจะถูกหักโดยอัตโนมัติในความถี่ที่กำหนด (เช่น ทุก 4 สัปดาห์)
- [x] ค่าเช่าและค่าสาธารณูปโภคจะถูกปรับตาม `InflationManager.CurrentInflationRate`
- [x] หากผู้เล่นไม่สามารถจ่ายค่าเช่า/ค่าสาธารณูปโภคได้, จะมีการลงโทษ (เช่น ความเครียดเพิ่มขึ้น, ความสุขลดลง, หรือการถูกไล่ออก)
- [x] ผู้เล่นสามารถอัปเกรดที่อยู่อาศัยหรือย้ายไปที่อยู่อาศัยอื่นได้
- [x] UI แสดงที่อยู่อาศัยปัจจุบัน, ค่าใช้จ่าย, และตัวเลือกที่อยู่อาศัยที่สามารถเลือกได้

## 3. Tasks / Subtasks (งานย่อย)
- [x] **1. สร้าง ScriptableObject สำหรับ Housing:**
  - [x] 1.1. สร้าง C# Script `HousingSO.cs` ที่สืบทอดจาก `ScriptableObject`
  - [x] 1.2. กำหนด Fields: `homeName`, `description`, `baseRent`, `baseUtilitiesCost`, `int capacity`, `float happinessBonus`, `HousingSO upgradeOption`
  - [x] 1.3. สร้าง Asset สำหรับที่อยู่อาศัยตัวอย่าง 2-3 ประเภท (เช่น "Small Apartment", "Medium Apartment", "House")

- [x] **2. สร้าง HousingManager Script:**
  - [x] 2.1. สร้าง C# Script ใหม่ชื่อ `HousingManager.cs` และทำให้เป็น Singleton
  - [x] 2.2. เก็บ Reference ไปยัง `CurrentHome` ของผู้เล่น

- [x] **3. ขยาย PlayerData สำหรับข้อมูลที่อยู่อาศัย:**
  - [x] 3.1. ใน `PlayerData.cs`, เพิ่ม `HousingSO currentHome;`

- [x] **4. พัฒนากลไกการเลือกที่อยู่อาศัยเริ่มต้น:**
  - [x] 4.1. สร้างฟังก์ชัน `public void SelectHome(HousingSO home)` ที่จะกำหนด `CurrentHome` ของผู้เล่น

- [x] **5. พัฒนากลไกการหักค่าใช้จ่ายประจำ:**
  - [x] 5.1. ให้ `HousingManager` ดักฟัง Event `OnWeekStart` จาก `TurnManager`
  - [x] 5.2. ใน `OnWeekStart` handler, ตรวจสอบว่าถึงรอบที่ต้องจ่ายค่าเช่า/ค่าสาธารณูปโภคหรือไม่ (เช่น ทุก 4 สัปดาห์)
  - [x] 5.3. คำนวณ `adjustedRent = CurrentHome.baseRent * (1 + InflationManager.CurrentInflationRate)`
  - [x] 5.4. คำนวณ `adjustedUtilities = CurrentHome.baseUtilitiesCost * (1 + InflationManager.CurrentInflationRate)`
  - [x] 5.5. พยายามหัก `adjustedRent + adjustedUtilities` จาก `PlayerStatsController.Money`

- [x] **6. พัฒนากลไกการจัดการการจ่าย/ไม่จ่ายและบทลงโทษ:**
  - [x] 6.1. หากเงินพอ: หักเงิน, ปรับ `happinessBonus`, ยิง Event แจ้งเตือนว่าจ่ายสำเร็จ
  - [x] 6.2. หากเงินไม่พอ: ปรับค่าสถานะลงโทษ (เช่น เพิ่ม Stress, ลด Happiness), ยิง Event แจ้งเตือนว่าจ่ายไม่สำเร็จ
  - [x] 6.3. (Optional) พิจารณากลไกการถูกไล่ออกหากค้างชำระหลายงวด

- [x] **7. พัฒนากลไกการอัปเกรด/ย้ายที่อยู่อาศัย:**
  - [x] 7.1. สร้างฟังก์ชัน `public bool CanUpgradeHome()` และ `public void UpgradeHome()`
  - [x] 7.2. สร้างฟังก์ชัน `public bool CanMoveToHome(HousingSO newHome)` และ `public void MoveToHome(HousingSO newHome)`

- [x] **8. เชื่อมต่อกับระบบ Event:**
  - [x] 8.1. ใช้ Global Event System สำหรับ Event ต่างๆ เช่น `OnHomeSelected`, `OnRentPaid`, `OnRentMissed`, `OnHomeUpgraded`, `OnHomeMoved`

- [x] **9. เขียน Unit Tests:**
  - [x] 9.1. เทสการเลือกที่อยู่อาศัย
  - [x] 9.2. เทสการหักค่าเช่า/ค่าสาธารณูปโภค (สำเร็จ/ไม่สำเร็จ) และการปรับตามเงินเฟ้อ
  - [x] 9.3. เทสกลไกการอัปเกรด/ย้ายที่อยู่อาศัย
  - [x] 9.4. เทสบทลงโทษเมื่อจ่ายไม่สำเร็จ

## 4. Dev Notes (บันทึกสำหรับนักพัฒนา)
- การออกแบบ `HousingSO` ให้ยืดหยุ่นจะช่วยให้เพิ่มประเภทที่อยู่อาศัยใหม่ๆ ได้ง่ายในอนาคต
- ควรมี UI ชั่วคราวสำหรับแสดงที่อยู่อาศัยปัจจุบัน, ค่าใช้จ่าย, และตัวเลือกการย้าย/อัปเกรด เพื่อใช้ในการดีบัก

## 5. QA / Testing Notes (บันทึกสำหรับ QA และการทดสอบ)
- ทดสอบการเลือกที่อยู่อาศัยเริ่มต้น
- ทดสอบการหักค่าเช่า/ค่าสาธารณูปโภคในทุกกรณี (จ่ายสำเร็จ, จ่ายไม่สำเร็จ)
- ทดสอบการปรับค่าใช้จ่ายตามอัตราเงินเฟ้อที่แตกต่างกัน
- ทดสอบบทลงโทษเมื่อจ่ายไม่สำเร็จ
- ทดสอบกลไกการอัปเกรด/ย้ายที่อยู่อาศัย

## 6. Dependencies (สตอรี่ที่เกี่ยวข้อง)
- **Story 1.2: Implement Turn & Time Management System:** `HousingManager` ต้องใช้ Event `OnWeekStart` เพื่อตรวจสอบค่าใช้จ่ายประจำ
- **Story 1.3: Implement Player Stats System:** `HousingManager` ต้องเรียกใช้ฟังก์ชันใน `PlayerStatsController` เพื่อจัดการเงินและค่าสถานะ
- **Story 1.5: Implement Global Event System:** ต้องใช้ระบบ Event กลางในการส่ง Event ต่างๆ
- **Story 2.1: Implement the core Inflation System:** `HousingManager` ต้องดึง `CurrentInflationRate` มาใช้ในการคำนวณค่าใช้จ่าย

---
## Dev Agent Record
- **Agent Model Used:** Gemini
- **Debug Log References:**
  - Created Housing.ts interface and HousingData.ts.
  - Created HousingManager.ts as a TypeScript Singleton.
  - Added currentHome to PlayerData.ts.
  - Added updateCurrentHome method to PlayerStatsController.ts.
  - Implemented selectHome method in HousingManager.ts.
  - Implemented weekly housing payment check mechanism in HousingManager.ts.
  - Implemented processHousingPayment method in HousingManager.ts.
  - Implemented canUpgradeHome, upgradeHome, canMoveToHome, and moveToHome methods in HousingManager.ts.
  - Created comprehensive unit tests for HousingManager.ts.
  - Created Housing.ts interface and HousingData.ts.
  - Created HousingManager.ts as a TypeScript Singleton.
- **Completion Notes:**
  - Implemented the Home/Housing System according to the story, adapting C#/.NET concepts to TypeScript/Phaser.
  - The system allows players to select homes, manage living expenses, and upgrade/move homes.
  - All core functionalities are complete and unit-tested.
- **File List:**
  - GameDev/Rich/src/Housing.ts
  - GameDev/Rich/src/HousingData.ts
  - GameDev/Rich/src/HousingManager.ts
  - GameDev/Rich/src/HousingManager.test.ts
  - GameDev/Rich/src/PlayerData.ts (updated)
  - GameDev/Rich/src/PlayerStatsController.ts (updated)
  - GameDev/Rich/src/Housing.ts
  - GameDev/Rich/src/HousingData.ts
  - GameDev/Rich/src/HousingManager.ts
- **Change Log:**
  - Initial implementation of Home/Housing System.
  - Integration with PlayerStatsController, GlobalEventEmitter, TurnManager, and InflationManager.
  - Unit tests for HousingManager.
