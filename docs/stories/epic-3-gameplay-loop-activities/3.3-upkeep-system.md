# Story 3.3: Implement Upkeep System

**Epic:** Gameplay Loop & Activities
**Status:** Ready for Review

## 1. Story
ในฐานะผู้เล่น (As a player), ฉันต้องการให้เกมหักค่าใช้จ่ายประจำสำหรับสิ่งจำเป็นต่างๆ เช่น อาหาร, ค่าเช่า, และเสื้อผ้า โดยที่ค่าใช้จ่ายเหล่านี้จะปรับตามอัตราเงินเฟ้อ (I want the game to automatically deduct recurring expenses for necessities like food, rent, and clothing, with costs adjusting based on inflation) เพื่อที่ฉันจะได้บริหารจัดการงบประมาณอย่างสมจริงและสัมผัสถึงผลกระทบของราคาที่สูงขึ้น (so I have to manage my budget realistically and feel the impact of rising prices).

## 2. Acceptance Criteria (เกณฑ์การยอมรับ)
- [x] มี `UpkeepManager.cs` Script ในโปรเจกต์
- [x] ระบบติดตามค่าใช้จ่ายประจำสำหรับ อาหาร (รายสัปดาห์), ค่าเช่า (ทุก 4 สัปดาห์), และเสื้อผ้า (ทุก 6 สัปดาห์)
- [x] ค่าใช้จ่ายพื้นฐานของแต่ละรายการถูกกำหนดไว้
- [x] ค่าใช้จ่ายจริงของแต่ละรายการจะถูกปรับตาม `InflationManager.CurrentInflationRate`
- [x] เมื่อเริ่มต้นสัปดาห์ที่เกี่ยวข้อง (เช่น ทุกสัปดาห์สำหรับอาหาร, ทุก 4 สัปดาห์สำหรับค่าเช่า), ระบบจะพยายามหักค่าใช้จ่ายจากเงินสดของผู้เล่น
- [x] หากผู้เล่นมีเงินเพียงพอ, ค่าใช้จ่ายจะถูกหักออก และค่าสถานะที่เกี่ยวข้อง (เช่น Health สำหรับอาหาร) จะถูกรักษาไว้
- [x] หากผู้เล่นมีเงินไม่เพียงพอ, จะมีการลงโทษ (เช่น Health/Happiness ลดลงสำหรับอาหารที่ขาด, Stress เพิ่มขึ้นสำหรับค่าเช่าที่ค้าง)
- [x] มีการแจ้งเตือนที่ชัดเจนแสดงให้ผู้เล่นทราบเมื่อมีการหักค่าใช้จ่ายหรือมีการลงโทษ

## 3. Tasks / Subtasks (งานย่อย)
- [x] **1. สร้าง ScriptableObject สำหรับ Upkeep Item:**
  - [x] 1.1. สร้าง C# Script `UpkeepItemSO.cs` ที่สืบทอดจาก `ScriptableObject`
  - [x] 1.2. กำหนด Fields: `itemName`, `baseCost`, `frequencyInWeeks`, `StatType statAffectedOnSuccess`, `float statChangeOnSuccess`, `StatType statAffectedOnFailure`, `float statChangeOnFailure`
  - [x] 1.3. สร้าง Asset สำหรับ Food, Rent, และ Clothing

- [x] **2. สร้าง UpkeepManager Script:**
  - [x] 2.1. สร้าง C# Script ใหม่ชื่อ `UpkeepManager.cs` และทำให้เป็น Singleton
  - [x] 2.2. เพิ่ม List ของ `UpkeepItemSO` Assets ที่จะถูกจัดการ

- [x] **3. พัฒนากลไกการตรวจสอบค่าใช้จ่ายประจำสัปดาห์:**
  - [x] 3.1. ให้ `UpkeepManager` ดักฟัง Event `OnWeekStart` จาก `TurnManager`
  - [x] 3.2. ใน `OnWeekStart` handler, วนลูปตรวจสอบ `UpkeepItemSO` แต่ละตัว
  - [x] 3.3. ตรวจสอบว่าถึงรอบที่ต้องจ่ายหรือไม่ (ใช้ `CurrentWeek % frequencyInWeeks == 0`)
  - [x] 3.4. คำนวณ `adjustedCost = baseCost * (1 + InflationManager.CurrentInflationRate)`

- [x] **4. พัฒนากลไกการจัดการการจ่าย/ไม่จ่าย:**
  - [x] 4.1. หากเงินพอ:
    - [x] หักเงินจาก `PlayerStatsController.Money`
    - [x] ปรับค่าสถานะ `statAffectedOnSuccess` ด้วย `statChangeOnSuccess`
    - [x] ยิง Event แจ้งเตือนว่าจ่ายสำเร็จ
  - [x] 4.2. หากเงินไม่พอ:
    - [x] ปรับค่าสถานะ `statAffectedOnFailure` ด้วย `statChangeOnFailure`
    - [x] ยิง Event แจ้งเตือนว่าจ่ายไม่สำเร็จและมีบทลงโทษ

- [x] **5. เชื่อมต่อกับระบบ Event:**
  - [x] 5.1. ใช้ Global Event System สำหรับ Event ต่างๆ เช่น `OnUpkeepPaid`, `OnUpkeepMissed`

- [x] **6. เขียน Unit Tests:**
  - [x] 6.1. เทสว่า Upkeep Item ถูกตรวจสอบตามความถี่ที่ถูกต้อง
  - [x] 6.2. เทสการปรับค่าใช้จ่ายตามเงินเฟ้อ
  - [x] 6.3. เทสกรณีจ่ายสำเร็จ (หักเงิน, เปลี่ยนค่าสถานะ, แจ้งเตือน)
  - [x] 6.4. เทสกรณีจ่ายไม่สำเร็จ (ไม่หักเงิน, ลงโทษ, แจ้งเตือน)

## 4. Dev Notes (บันทึกสำหรับนักพัฒนา)
- การออกแบบ `UpkeepItemSO` ให้ยืดหยุ่นจะช่วยให้เพิ่มค่าใช้จ่ายประจำใหม่ๆ ได้ง่ายในอนาคต
- ควรมี UI ชั่วคราวสำหรับแสดงสถานะค่าใช้จ่ายประจำ และการแจ้งเตือนเมื่อถึงกำหนดจ่าย เพื่อใช้ในการดีบัก

## 5. QA / Testing Notes (บันทึกสำหรับ QA และการทดสอบ)
- ทดสอบการหักค่าใช้จ่ายประจำในทุกกรณี (จ่ายสำเร็จ, จ่ายไม่สำเร็จ)
- ทดสอบการปรับค่าใช้จ่ายตามอัตราเงินเฟ้อที่แตกต่างกัน
- ทดสอบการลงโทษเมื่อจ่ายไม่สำเร็จ ว่าถูกต้องตามที่กำหนด
- ทดสอบการแจ้งเตือนว่าแสดงผลถูกต้อง

## 6. Dependencies (สตอรี่ที่เกี่ยวข้อง)
- **Story 1.2: Implement Turn & Time Management System:** `UpkeepManager` ต้องใช้ Event `OnWeekStart` เพื่อตรวจสอบค่าใช้จ่ายประจำ
- **Story 1.3: Implement Player Stats System:** `UpkeepManager` ต้องเรียกใช้ฟังก์ชันใน `PlayerStatsController` เพื่อจัดการเงินและค่าสถานะ
- **Story 1.5: Implement Global Event System:** ต้องใช้ระบบ Event กลางในการส่ง Event ต่างๆ
- **Story 2.1: Implement the core Inflation System:** `UpkeepManager` ต้องดึง `CurrentInflationRate` มาใช้ในการคำนวณค่าใช้จ่าย

---
## Dev Agent Record
- **Agent Model Used:** Gemini
- **Debug Log References:**
  - Created UpkeepItem.ts interface and UpkeepItemsData.ts.
  - Created UpkeepManager.ts as a TypeScript Singleton.
  - Implemented weekly upkeep check mechanism in UpkeepManager.ts.
  - Implemented processUpkeepPayment method in UpkeepManager.ts.
  - Created comprehensive unit tests for UpkeepManager.ts.
  - Created UpkeepItem.ts interface and UpkeepItemsData.ts.
  - Created UpkeepManager.ts as a TypeScript Singleton.
- **Completion Notes:**
  - Implemented the Upkeep System according to the story, adapting C#/.NET concepts to TypeScript/Phaser.
  - The system automatically deducts recurring expenses and applies penalties if not paid.
  - All core functionalities are complete and unit-tested.
- **File List:**
  - GameDev/Rich/src/UpkeepItem.ts
  - GameDev/Rich/src/UpkeepItemsData.ts
  - GameDev/Rich/src/UpkeepManager.ts
  - GameDev/Rich/src/UpkeepManager.test.ts
  - GameDev/Rich/src/PlayerStatsController.ts (updated)
  - GameDev/Rich/src/InflationManager.ts (updated)
  - GameDev/Rich/src/UpkeepItem.ts
  - GameDev/Rich/src/UpkeepItemsData.ts
  - GameDev/Rich/src/UpkeepManager.ts
- **Change Log:**
  - Initial implementation of Upkeep System.
  - Integration with PlayerStatsController, GlobalEventEmitter, TurnManager, and InflationManager.
  - Unit tests for UpkeepManager.
