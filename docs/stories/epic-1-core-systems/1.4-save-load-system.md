# Story 1.4: Implement Save/Load System

**Epic:** Core Systems & Player Foundation

## 1. Story
ในฐานะผู้เล่น (As a player), ฉันต้องการที่จะบันทึกความคืบหน้าของเกมและโหลดขึ้นมาเล่นต่อได้ในภายหลัง (I want to be able to save my game progress and load it later) เพื่อที่ฉันจะได้ไม่ต้องเริ่มต้นใหม่ทั้งหมดทุกครั้งที่เล่น (so I don't have to start over every time I play).

## 2. Acceptance Criteria (เกณฑ์การยอมรับ)
- [x] มี `SaveLoadManager.cs` Script ในโปรเจกต์
- [x] ผู้เล่นสามารถกดบันทึกเกมได้ (เช่น ผ่านปุ่มในเมนู Pause) และระบบจะสร้างไฟล์เซฟเก็บไว้ในเครื่อง
- [x] เมื่อเปิดเกม, ระบบสามารถตรวจสอบได้ว่ามีไฟล์เซฟเก่าอยู่หรือไม่
- [x] หากมีไฟล์เซฟอยู่, ที่หน้าเมนูหลักจะแสดงปุ่ม "Continue" หรือ "เล่นต่อ"
- [x] การโหลดเกมสามารถคืนค่าสถานะของผู้เล่น (`PlayerData`) และข้อมูลเทิร์นปัจจุบัน (`TurnManager`) ได้อย่างถูกต้อง
- [x] การบันทึกเกมจะเขียนทับไฟล์เซฟเดิมที่มีอยู่

## 3. Tasks / Subtasks (งานย่อย)
- [x] **1. สร้าง SaveLoadManager Script:**
  - [x] 1.1. สร้าง C# Script ใหม่ชื่อ `SaveLoadManager.cs` และทำให้เป็น Singleton

- [x] **2. สร้างคลาสสำหรับเก็บข้อมูลเซฟ:**
  - [x] 2.1. สร้าง C# Script ใหม่ชื่อ `GameSaveData.cs` (ไม่ต้องสืบทอดจาก MonoBehaviour)
  - [x] 2.2. คลาสนี้จะเก็บข้อมูลทั้งหมดที่ต้องเซฟ เช่น `public PlayerData playerData;`, `public int currentWeek;`
  - [x] 2.3. กำหนดให้คลาสเป็น `[System.Serializable]`

- [x] **3. พัฒนากลไกการบันทึกเกม:**
  - [x] 3.1. สร้างฟังก์ชัน `public void SaveGame()`
  - [x] 3.2. ภายในฟังก์ชันนี้ ให้รวบรวมข้อมูลจาก Manager อื่นๆ (เช่น `PlayerStatsController`, `TurnManager`) มาใส่ใน instance ของ `GameSaveData`
  - [x] 3.3. แปลง instance ของ `GameSaveData` เป็น JSON string
  - [x] 3.4. บันทึก JSON string ลงเป็นไฟล์โดยใช้ `Application.persistentDataPath`

- [x] **4. พัฒนากลไกการโหลดเกม:**
  - [x] 4.1. สร้างฟังก์ชัน `public GameSaveData LoadGame()`
  - [x] 4.2. ภายในฟังก์ชันนี้ ให้ตรวจสอบว่ามีไฟล์เซฟอยู่หรือไม่
  - [x] 4.3. ถ้ามี, ให้อ่านไฟล์แล้วแปลง JSON string กลับมาเป็น object ของ `GameSaveData` แล้ว return ค่ากลับไป
  - [x] 4.4. ถ้าไม่มี, ให้ return `null`

- [x] **5. เชื่อมต่อกับระบบอื่นๆ:**
  - [x] 5.1. ใน `GameManager`, ให้เรียก `SaveLoadManager.LoadGame()` ตอนเริ่มเกม เพื่อตรวจสอบและแสดง/ซ่อนปุ่ม "Continue"
  - [x] 5.2. เมื่อผู้เล่นกด "Continue", `GameManager` จะต้องส่งข้อมูลที่โหลดมาไปให้ Manager อื่นๆ (เช่น `PlayerStatsController.LoadPlayerData(data)`)
  - [x] 5.3. สร้างปุ่ม "Save Game" ในหน้าจอ Pause Menu เพื่อเรียกใช้ `SaveLoadManager.SaveGame()`

- [x] **6. เขียน Unit Tests:**
  - [x] 6.1. เทสว่า `SaveGame` สามารถสร้างไฟล์ได้จริง
  - [x] 6.2. เทสว่า `LoadGame` สามารถอ่านไฟล์และคืนค่าข้อมูลที่ถูกต้องได้
  - [x] 6.3. เทสการทำงานทั้งวงจร (Save -> Load -> ตรวจสอบข้อมูล) ว่าข้อมูลตรงกัน

## 4. Dev Notes (บันทึกสำหรับนักพัฒนา)
- การจัดการเวอร์ชันของไฟล์เซฟเป็นเรื่องสำคัญ อาจต้องพิจารณาเพิ่ม field `saveVersion` ใน `GameSaveData` เผื่อมีการเปลี่ยนแปลงโครงสร้างข้อมูลในอนาคต
- ควรพิจารณาการเข้ารหัสไฟล์เซฟเบื้องต้นเพื่อป้องกันการแก้ไขโดยผู้เล่นโดยตรง

## 5. QA / Testing Notes (บันทึกสำหรับ QA และการทดสอบ)
- ทดสอบการเซฟและโหลดในทุกๆ สถานะของเกม (MainMenu, GamePlaying, Paused)
- ทดสอบการปิดเกมทันทีหลังจากเซฟ แล้วเปิดขึ้นมาใหม่เพื่อโหลด
- ทดสอบกรณีที่ไฟล์เซฟเสียหาย (corrupted) ว่าเกมสามารถจัดการได้หรือไม่ (เช่น แจ้งเตือนผู้เล่น หรือเริ่มเกมใหม่)

## 6. Dependencies (สตอรี่ที่เกี่ยวข้อง)
- **Story 1.2: Implement Turn & Time Management System:** ต้องดึงข้อมูล `CurrentWeek` มาบันทึก
- **Story 1.3: Implement Player Stats System:** ต้องดึง `PlayerData` มาบันทึก

---
## Dev Agent Record
- **Agent Model Used:** Gemini
- **Debug Log References:**
  - Implemented `GameSaveData.ts` for save data structure.
  - Implemented `SaveLoadManager.ts` as a TypeScript Singleton.
  - Used `localStorage` for game save data persistence.
  - Integrated `SaveLoadManager` with `main.ts` by adding Save/Load buttons and logic.
  - Integrated `SaveLoadManager` with `PlayerStatsController` and `TurnManager` for data handling.
  - Wrote comprehensive unit tests for `SaveLoadManager` covering all specified tasks and acceptance criteria.
  - All 37 unit tests for `GameManager`, `TurnManager`, `PlayerStatsController`, and `SaveLoadManager` passed successfully.
- **Completion Notes:**
  - Implemented the Save/Load System according to the story, adapting C#/.NET concepts to TypeScript/Phaser.
  - The system allows saving and loading game progress, including player stats and current week.
  - It handles cases with no save data and corrupted save data.
  - The core functionality is complete and unit-tested.
- **File List:**
  - `GameDev/Rich/src/GameSaveData.ts`
  - `GameDev/Rich/src/SaveLoadManager.ts`
  - `GameDev/Rich/src/SaveLoadManager.test.ts`
  - `GameDev/Rich/src/main.ts` (updated)
- **Change Log:**
  - Initial implementation of Save/Load System.
  - Integration with PlayerStatsController and TurnManager.
  - Unit tests for SaveLoadManager.