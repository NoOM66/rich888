# Story 1.2: Implement Turn & Time Management System

**Epic:** Core Systems & Player Foundation

## 1. Story
ในฐานะผู้เล่น (As a player), ฉันต้องการระบบที่จัดการการเดินของเกมเป็นรอบสัปดาห์และมี "งบเวลา" ที่จำกัดในแต่ละสัปดาห์ (I want a system that manages game turns on a weekly basis and provides a limited "time budget" each week) เพื่อที่ฉันจะได้วางแผนการใช้เวลาทำกิจกรรมต่างๆ ได้อย่างมีกลยุทธ์ (so that I can strategically plan how to spend my time on various activities).

## 2. Acceptance Criteria (เกณฑ์การยอมรับ)
- [x] มี `TurnManager.cs` Script ในโปรเจกต์
- [x] เกมดำเนินไปเป็นเทิร์น (สัปดาห์) อย่างชัดเจน
- [x] เมื่อเริ่มต้นสัปดาห์ใหม่, Event `OnWeekStart` จะต้องถูกส่งออกมา
- [x] เมื่อเริ่มต้นสัปดาห์ใหม่, "งบเวลา" (Time Budget) ของผู้เล่นจะถูกรีเซ็ตเป็นค่าเริ่มต้น (เช่น 168 ชั่วโมง)
- [x] การเลือกทำกิจกรรมต่างๆ จะต้องลด "งบเวลา" ลงอย่างถูกต้องตามที่กิจกรรมนั้นๆ กำหนด
- [x] เมื่อ "งบเวลา" หมดลง หรือเมื่อผู้เล่นกดยืนยันจบสัปดาห์, Event `OnWeekEnd` จะต้องถูกส่งออกมา และสัปดาห์ใหม่จะเริ่มต้นขึ้น

## 3. Tasks / Subtasks (งานย่อย)
- [x] **1. สร้าง TurnManager Script:**
  - [x] 1.1. สร้าง C# Script ใหม่ชื่อ `TurnManager.cs`
  - [x] 1.2. ทำให้เป็น Singleton เพื่อให้ระบบอื่นเรียกใช้งานได้สะดวก

- [x] **2. กำหนดค่าและตัวแปรสำหรับเทิร์น:**
  - [x] 2.1. สร้าง Properties สำหรับ `CurrentWeek` (int) และ `TimeBudget` (float)
  - [x] 2.2. กำหนดค่าคงที่สำหรับงบเวลาเริ่มต้น `DEFAULT_WEEKLY_BUDGET` (เช่น 168 ชั่วโมง)

- [x] **3. พัฒนากลไกหลักของเทิร์น:**
  - [x] 3.1. สร้างฟังก์ชัน `private void StartNewWeek()` ที่จะเพิ่มค่า `CurrentWeek`, รีเซ็ต `TimeBudget`, และยิง Event `OnWeekStart`
  - [x] 3.2. สร้างฟังก์ชัน `public void EndCurrentWeek()` ที่จะถูกเรียกเมื่อผู้เล่นกดยืนยันจบสัปดาห์ หรือเมื่อ `TimeBudget` หมด

- [x] **4. พัฒนาระบบจัดการงบเวลา:**
  - [x] 4.1. สร้างฟังก์ชัน `public bool TrySpendTime(float hours)` เพื่อใช้ในการลดเวลาเมื่อทำกิจกรรม โดยจะคืนค่า `true` หากมีเวลาพอ และ `false` หากไม่พอ

- [x] **5. เชื่อมต่อกับระบบ Event:**
  - [x] 5.1. สร้าง `public static event Action OnWeekStart;` และ `public static event Action OnWeekEnd;`
  - [x] 5.2. ตรวจสอบให้แน่ใจว่า Event ถูกเรียกใช้ใน `StartNewWeek()` และ `EndCurrentWeek()`

- [x] **6. เชื่อมต่อกับ GameManager:**
  - [x] 6.1. `TurnManager` ต้องดักฟัง Event `OnGameStateChanged` จาก `GameManager`
  - [x] 6.2. เมื่อเกมเข้าสู่สถานะ `GamePlaying`, `TurnManager` จะต้องเริ่มสัปดาห์แรก

- [x] **7. เขียน Unit Tests:**
  - [x] 7.1. เทสว่า `StartNewWeek` เพิ่มสัปดาห์และรีเซ็ตเวลาได้ถูกต้อง
  - [x] 7.2. เทสว่า `TrySpendTime` ลดเวลาและจัดการกรณีเวลาไม่พอได้ถูกต้อง
  - [x] 7.3. เทสว่า Event `OnWeekStart` และ `OnWeekEnd` ถูกเรียกใช้ตามที่คาดหวัง

## 4. Dev Notes (บันทึกสำหรับนักพัฒนา)
- `TurnManager` ควรเป็นระบบที่ทำงานอยู่เบื้องหลัง ไม่ควรมีส่วนของ UI โดยตรง แต่จะส่งข้อมูลไปให้ UIManager แสดงผล

## 5. QA / Testing Notes (บันทึกสำหรับ QA และการทดสอบ)
- ต้องทดสอบกรณีที่ `TimeBudget` เหลือ 0 ว่าเกมสามารถไปต่อสัปดาห์ถัดไปได้อัตโนมัติหรือไม่
- ทดสอบการกดปุ่ม "End Week" ในขณะที่เวลายังเหลือ ว่าทำงานได้ถูกต้องหรือไม่

## 6. Dependencies (สตอรี่ที่เกี่ยวข้อง)
- **Story 1.1: Implement GameManager and State Machine:** `TurnManager` จำเป็นต้องรู้สถานะของเกมจาก `GameManager` เพื่อเริ่มหรือหยุดการทำงาน

---
## Dev Agent Record
- **Agent Model Used:** Gemini
- **Debug Log References:**
  - Implemented `TurnManager` as a TypeScript Singleton.
  - Integrated `TurnManager` with `GameManager` by listening to `onGameStateChanged` event.
  - Added UI elements in `main.ts` to display week and time budget, and buttons to spend time and end week.
  - Wrote comprehensive unit tests for `TurnManager` covering all specified tasks and acceptance criteria.
  - Resolved multiple TypeScript and Jest mocking issues during unit testing of `TurnManager`.
  - All 16 unit tests for `TurnManager` and `GameManager` passed successfully.
- **Completion Notes:**
  - Implemented the Turn & Time Management System according to the story, adapting C#/.NET concepts to TypeScript/Phaser.
  - The `TurnManager` is a singleton, manages game turns (weeks), and a time budget.
  - It correctly emits `onWeekStart` and `onWeekEnd` events.
  - It integrates with `GameManager` to start the first week when the game enters `GamePlaying` state.
  - The core functionality is complete and unit-tested.
- **File List:**
  - `GameDev/Rich/src/TurnManager.ts`
  - `GameDev/Rich/src/TurnManager.test.ts`
  - `GameDev/Rich/src/main.ts` (updated)
- **Change Log:**
  - Initial implementation of Turn & Time Management System.
  - Integration with GameManager.
  - Unit tests for TurnManager.