# Story 1.2: Implement Turn & Time Management System (Phaser / TypeScript)

**Epic:** Core Systems & Player Foundation

## 1. Story
ในฐานะผู้เล่น (As a player), ฉันต้องการระบบที่จัดการการเดินของเกมเป็นรอบสัปดาห์และมี "งบเวลา" ที่จำกัดในแต่ละสัปดาห์ (I want a system that manages game turns on a weekly basis and provides a limited "time budget" each week) เพื่อที่ฉันจะได้วางแผนการใช้เวลาทำกิจกรรมต่างๆ ได้อย่างมีกลยุทธ์ (so that I can strategically plan how to spend my time on various activities).

## 2. Acceptance Criteria (เกณฑ์การยอมรับ)
- มีไฟล์ `GameDev/Rich/src/TurnManager.ts` (Phaser/TypeScript implementation)
- เกมดำเนินไปเป็นเทิร์น (สัปดาห์) อย่างชัดเจน
- เมื่อเริ่มต้นสัปดาห์ใหม่, `TurnManager` จะ emit เหตุการณ์ `onWeekStart` ผ่าน `Phaser.Events.EventEmitter` หรือ event system ที่ทีมใช้
- เมื่อเริ่มต้นสัปดาห์ใหม่, `TurnManager` จะรีเซ็ต `timeBudget` ของผู้เล่นเป็นค่าเริ่มต้น (ตัวอย่างค่า: 168 ชั่วโมง)
- การเลือกทำกิจกรรมต่างๆ จะต้องลด `timeBudget` ลงอย่างถูกต้องตามเวลาของกิจกรรม
- เมื่อ `timeBudget` หมดลง หรือผู้เล่นกดยืนยันจบสัปดาห์, `TurnManager` จะ emit เหตุการณ์ `onWeekEnd` และเริ่มสัปดาห์ใหม่

## 3. Tasks / Subtasks (งานย่อย)
- 1. สร้าง `TurnManager.ts` (Phaser/TypeScript implementation)
  - 1.1. สร้างไฟล์ `GameDev/Rich/src/TurnManager.ts`
  - 1.2. ทำให้เป็น singleton / shared service ตามแนวทางของโปรเจกต์ (เช่น export instance หรือใช้ dependency injection)

- 2. กำหนดค่าและตัวแปรสำหรับเทิร์น
  - 2.1. สร้าง properties: `currentWeek: number` และ `timeBudget: number`
  - 2.2. กำหนดค่าคงที่ `DEFAULT_WEEKLY_BUDGET = 168` (ชั่วโมง)

- 3. พัฒนากลไกหลักของเทิร์น
  - 3.1. สร้างเมธอด `private startNewWeek(): void` ที่เพิ่ม `currentWeek`, รีเซ็ต `timeBudget` และ emit `'onWeekStart'`
  - 3.2. สร้างเมธอด `public endCurrentWeek(): void` ที่ emit `'onWeekEnd'` และเรียก `startNewWeek()`

- 4. พัฒนาระบบจัดการงบเวลา
  - 4.1. สร้างเมธอด `public trySpendTime(hours: number): boolean` — ลด `timeBudget` ถ้ามีพอและคืนค่า `true` หากสำเร็จ, คืนค่า `false` ถ้าไม่พอ
  - 4.2. ถ้า `timeBudget` ลดลงเหลือ <= 0 ให้เรียก `endCurrentWeek()` อัตโนมัติ

- 5. เชื่อมต่อกับระบบ Event (Phaser)
  - 5.1. ใช้ `Phaser.Events.EventEmitter` หรือ shared EventEmitter ของโปรเจกต์ เพื่อ emit/subscribe events (`onWeekStart`, `onWeekEnd`, `timeBudgetChanged` เป็นตัวอย่าง)
  - 5.2. ตรวจสอบ contract ของ events (payloads เช่น `{ currentWeek, timeBudget }` เมื่อ emit)

- 6. เชื่อมต่อกับ GameManager / State Manager
  - 6.1. `TurnManager` ต้อง subscribe การเปลี่ยนสถานะของเกมจาก `GameManager` (เช่น `gameManager.events.on('state-changed', ...)`)
  - 6.2. เมื่อสถานะเป็น `playing` ให้เริ่มสัปดาห์แรก (เรียก `startNewWeek()`)

- 7. เขียน Unit Tests (Jest)
  - 7.1. สร้าง `GameDev/Rich/src/TurnManager.test.ts`
  - 7.2. เทสว่า `startNewWeek()` เพิ่ม `currentWeek` และรีเซ็ต `timeBudget`
  - 7.3. เทสว่า `trySpendTime()` ลด `timeBudget` และคืนค่า boolean ที่ถูกต้อง
  - 7.4. เทสว่า events `onWeekStart` และ `onWeekEnd` ถูก emit พร้อม payload ที่คาดหวัง

## 4. Dev Notes (บันทึกสำหรับนักพัฒนา)
- `TurnManager` ควรเป็นระบบ backend-like ของเกม (ไม่ควรผูก UI) — ให้ UI สังเกต/subscribe events เพื่ออัปเดตการแสดงผล
- Events ควรมี payload สั้นๆ (เช่น `{ currentWeek, timeBudget }`) เพื่อให้ UI/ระบบอื่นใช้งานได้ง่าย

## 5. QA / Testing Notes (บันทึกสำหรับ QA และการทดสอบ)
- ทดสอบการไหลอัตโนมัติเมื่อ `timeBudget` เหลือ 0 ว่า `onWeekEnd` ถูก emit และ `currentWeek` เพิ่มขึ้น
- ทดสอบการกด "End Week" ในขณะที่เวลายังเหลือว่า trigger ถูกต้องและ payload ถูกต้อง
- ทดสอบ race conditions (เช่น เรียก `trySpendTime` หลายครั้งต่อเนื่อง) ในระดับหน่วย

## 6. Dependencies (สตอรี่ที่เกี่ยวข้อง)
- **Story 1.1: Implement GameManager and State Machine:** `TurnManager` จำเป็นต้องรู้สถานะของเกมจาก `GameManager` เพื่อเริ่มหรือหยุดการทำงาน

---
## Implementation Notes / Dev Agent Record
- **Target implementation:** Phaser 3 + TypeScript
- **Suggested path / files:**
  - `GameDev/Rich/src/TurnManager.ts` (core implementation)
  - `GameDev/Rich/src/TurnManager.test.ts` (unit tests with Jest)
- **Event conventions:** Use `Phaser.Events.EventEmitter` or a shared EventEmitter; emit `onWeekStart` and `onWeekEnd` with payload `{ currentWeek, timeBudget }`.
- **Testing:** Use Jest with minimal mocking of Phaser EventEmitter (or extract event interface to be easily mockable).
- **Notes:** Keep TurnManager UI‑free; expose clear, typed API for other systems to call/subscribe.