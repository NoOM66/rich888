# Story 1.2: Implement Turn & Time Management System

**Epic:** Core Systems & Player Foundation

## 1. Story
ในฐานะผู้เล่น (As a player), ฉันต้องการระบบที่จัดการการเดินของเกมเป็นรอบสัปดาห์และมี "งบเวลา" ที่จำกัดในแต่ละสัปดาห์ (I want a system that manages game turns on a weekly basis and provides a limited "time budget" each week) เพื่อที่ฉันจะได้วางแผนการใช้เวลาทำกิจกรรมต่างๆ ได้อย่างมีกลยุทธ์ (so that I can strategically plan how to spend my time on various activities).

## 2. Acceptance Criteria (เกณฑ์การยอมรับ)
- [ ] มี `TurnManager.cs` Script ในโปรเจกต์
- [ ] เกมดำเนินไปเป็นเทิร์น (สัปดาห์) อย่างชัดเจน
- [ ] เมื่อเริ่มต้นสัปดาห์ใหม่, Event `OnWeekStart` จะต้องถูกส่งออกมา
- [ ] เมื่อเริ่มต้นสัปดาห์ใหม่, "งบเวลา" (Time Budget) ของผู้เล่นจะถูกรีเซ็ตเป็นค่าเริ่มต้น (เช่น 168 ชั่วโมง)
- [ ] การเลือกทำกิจกรรมต่างๆ จะต้องลด "งบเวลา" ลงอย่างถูกต้องตามที่กิจกรรมนั้นๆ กำหนด
- [ ] เมื่อ "งบเวลา" หมดลง หรือเมื่อผู้เล่นกดยืนยันจบสัปดาห์, Event `OnWeekEnd` จะต้องถูกส่งออกมา และสัปดาห์ใหม่จะเริ่มต้นขึ้น

## 3. Tasks / Subtasks (งานย่อย)
- [ ] **1. สร้าง TurnManager Script:**
  - [ ] 1.1. สร้าง C# Script ใหม่ชื่อ `TurnManager.cs`
  - [ ] 1.2. ทำให้เป็น Singleton เพื่อให้ระบบอื่นเรียกใช้งานได้สะดวก

- [ ] **2. กำหนดค่าและตัวแปรสำหรับเทิร์น:**
  - [ ] 2.1. สร้าง Properties สำหรับ `CurrentWeek` (int) และ `TimeBudget` (float)
  - [ ] 2.2. กำหนดค่าคงที่สำหรับงบเวลาเริ่มต้น `DEFAULT_WEEKLY_BUDGET` (เช่น 168 ชั่วโมง)

- [ ] **3. พัฒนากลไกหลักของเทิร์น:**
  - [ ] 3.1. สร้างฟังก์ชัน `private void StartNewWeek()` ที่จะเพิ่มค่า `CurrentWeek`, รีเซ็ต `TimeBudget`, และยิง Event `OnWeekStart`
  - [ ] 3.2. สร้างฟังก์ชัน `public void EndCurrentWeek()` ที่จะถูกเรียกเมื่อผู้เล่นกดยืนยันจบสัปดาห์ หรือเมื่อ `TimeBudget` หมด

- [ ] **4. พัฒนาระบบจัดการงบเวลา:**
  - [ ] 4.1. สร้างฟังก์ชัน `public bool TrySpendTime(float hours)` เพื่อใช้ในการลดเวลาเมื่อทำกิจกรรม โดยจะคืนค่า `true` หากมีเวลาพอ และ `false` หากไม่พอ

- [ ] **5. เชื่อมต่อกับระบบ Event:**
  - [ ] 5.1. สร้าง `public static event Action OnWeekStart;` และ `public static event Action OnWeekEnd;`
  - [ ] 5.2. ตรวจสอบให้แน่ใจว่า Event ถูกเรียกใช้ใน `StartNewWeek()` และ `EndCurrentWeek()`

- [ ] **6. เชื่อมต่อกับ GameManager:**
  - [ ] 6.1. `TurnManager` ต้องดักฟัง Event `OnGameStateChanged` จาก `GameManager`
  - [ ] 6.2. เมื่อเกมเข้าสู่สถานะ `GamePlaying`, `TurnManager` จะต้องเริ่มสัปดาห์แรก

- [ ] **7. เขียน Unit Tests:**
  - [ ] 7.1. เทสว่า `StartNewWeek` เพิ่มสัปดาห์และรีเซ็ตเวลาได้ถูกต้อง
  - [ ] 7.2. เทสว่า `TrySpendTime` ลดเวลาและจัดการกรณีเวลาไม่พอได้ถูกต้อง
  - [ ] 7.3. เทสว่า Event `OnWeekStart` และ `OnWeekEnd` ถูกเรียกใช้ตามที่คาดหวัง

## 4. Dev Notes (บันทึกสำหรับนักพัฒนา)
- `TurnManager` ควรเป็นระบบที่ทำงานอยู่เบื้องหลัง ไม่ควรมีส่วนของ UI โดยตรง แต่จะส่งข้อมูลไปให้ UIManager แสดงผล

## 5. QA / Testing Notes (บันทึกสำหรับ QA และการทดสอบ)
- ต้องทดสอบกรณีที่ `TimeBudget` เหลือ 0 ว่าเกมสามารถไปต่อสัปดาห์ถัดไปได้อัตโนมัติหรือไม่
- ทดสอบการกดปุ่ม "End Week" ในขณะที่เวลายังเหลือ ว่าทำงานได้ถูกต้องหรือไม่

## 6. Dependencies (สตอรี่ที่เกี่ยวข้อง)
- **Story 1.1: Implement GameManager and State Machine:** `TurnManager` จำเป็นต้องรู้สถานะของเกมจาก `GameManager` เพื่อเริ่มหรือหยุดการทำงาน

---
## Dev Agent Record
- **Agent Model Used:**
- **Debug Log References:**
- **Completion Notes:**
- **File List:**
- **Change Log:**
